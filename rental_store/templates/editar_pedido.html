{% extends 'base.html' %}
{% block title %}Editar Pedido{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
  .flatpickr-day.available {
    background-color: #a3e635 !important;
    border-radius: 50% !important;
    color: black !important;
  }
</style>

<div class="container" style="max-width: 600px;">
  <h3 class="mb-4">Editar Pedido</h3>
  <form method="POST">
    <div class="mb-3">
      <label class="form-label">Cliente</label>
      <select name="cliente_id" id="cliente_id" class="form-select" required>
        {% for cliente in clientes %}
        <option value="{{ cliente.id }}" {% if cliente.id == pedido.cliente_id %}selected{% endif %}>
          {{ cliente.nome }} - {{ cliente.telefone }}
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Item</label>
      <select name="item_id" id="item_id" class="form-select" required>
        {% for item in itens %}
        <option value="{{ item.id }}" {% if item.id == pedido.item_id %}selected{% endif %}>
          {{ item.nome }} ({{ item.modelo }})
        </option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Data do Evento</label>
      <input type="text" name="data_evento" id="data_evento" class="form-control"
             value="{{ pedido.data_evento.strftime('%Y-%m-%d') }}" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Data da Prova</label>
      <input type="text" name="data_prova" id="data_prova" class="form-control"
             value="{{ pedido.data_prova.strftime('%Y-%m-%d') if pedido.data_prova }}">
    </div>

    <div class="mb-3">
      <label class="form-label">Data de Retirada</label>
      <input type="date" name="data_retirada" id="data_retirada" class="form-control"
             value="{{ pedido.data_retirada.strftime('%Y-%m-%d') if pedido.data_retirada }}">
    </div>

    <div class="mb-3">
      <label class="form-label">Data de Devolução</label>
      <input type="text" name="data_devolucao" id="data_devolucao" class="form-control"
             value="{{ pedido.data_devolucao.strftime('%Y-%m-%d') if pedido.data_devolucao }}">
    </div>

    <div class="mb-3">
      <label class="form-label">Observações</label>
      <textarea name="observacoes" class="form-control" rows="3">{{ pedido.observacoes }}</textarea>
    </div>

    <button type="submit" class="btn btn-primary w-100">
      <i class="bi bi-save"></i> Salvar Alterações
    </button>
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  $(document).ready(function () {
    $('#cliente_id').select2();
    $('#item_id').select2();

    const datasBloqueadas = {{ datas_bloqueadas|tojson }};
    const datasLivres = {{ datas_livres|tojson }};
    const datasLivresDevolucao = {{ datas_livres_devolucao|tojson }};

    function aplicarFlatpickr(selector, onChangeCallback, listaLivre = datasLivres) {
      flatpickr(selector, {
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: [
          function(date) {
            return datasBloqueadas.includes(date.toISOString().split('T')[0]);
          }
        ],
        onDayCreate: function(dObj, dStr, fp, dayElem) {
          const dateStr = dayElem.dateObj.toISOString().split('T')[0];
          if (listaLivre.includes(dateStr)) {
            dayElem.classList.add("available");
          }
        },
        onChange: onChangeCallback
      });
    }

    aplicarFlatpickr("#data_evento", function(selectedDates, dateStr) {
      const evento = new Date(dateStr);
      if (!isNaN(evento)) {
        const retirada = new Date(evento);
        retirada.setDate(retirada.getDate() - 1);
        const devolucao = new Date(evento);
        devolucao.setDate(devolucao.getDate() + 1);

        $('#data_retirada').val(retirada.toISOString().split('T')[0]);
        $('#data_devolucao').val(devolucao.toISOString().split('T')[0]);
      }
    });

    aplicarFlatpickr("#data_prova");
    aplicarFlatpickr("#data_devolucao", null, datasLivresDevolucao);
  });
</script>
{% endblock %}
