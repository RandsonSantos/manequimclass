{% extends 'base.html' %}
{% block title %}Fazer Pedido{% endblock %}

{% block content %}
<!-- Select2 CSS + Flatpickr CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Estilo para datas livres -->
<style>
  .flatpickr-day.available {
    background-color: #a3e635 !important;
    border-radius: 50% !important;
    color: black !important;
  }
</style>

<div class="container" style="max-width: 600px;">
  <h3 class="mb-4">Fazer Novo Pedido</h3>
  <form method="POST">
    <div class="mb-3">
      <label class="form-label">Cliente</label>
      <select name="cliente_id" id="cliente_id" class="form-select" required>
        <option value="">Selecione um cliente</option>
        {% for cliente in clientes %}
        <option value="{{ cliente.id }}">{{ cliente.nome }} - {{ cliente.telefone }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Item</label>
      <select name="item_id" id="item_id" class="form-select" required>
        <option value="">Selecione um item</option>
        {% for item in itens %}
        <option value="{{ item.id }}">{{ item.nome }} ({{ item.modelo }})</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label">Data do Evento</label>
      <input type="text" name="data_evento" id="data_evento" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Data da Prova</label>
      <input type="text" name="data_prova" id="data_prova" class="form-control">
    </div>

    <div class="mb-3">
      <label class="form-label">Data de Retirada</label>
      <input type="date" name="data_retirada" id="data_retirada" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label">Data de Devolução</label>
      <input type="date" name="data_devolucao" id="data_devolucao" class="form-control" readonly>
    </div>

    <div class="mb-3">
      <label class="form-label">Observações</label>
      <textarea name="observacoes" class="form-control" rows="3"></textarea>
    </div>

    <button type="submit" class="btn btn-success w-100">
      <i class="bi bi-cart-check"></i> Finalizar Pedido
    </button>
  </form>
</div>

<!-- jQuery + Select2 + Flatpickr JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
  $(document).ready(function () {
    $('#cliente_id').select2({ placeholder: 'Selecione um cliente', allowClear: true });
    $('#item_id').select2({ placeholder: 'Selecione um item', allowClear: true });

    const datasBloqueadas = {{ datas_bloqueadas|default([])|tojson }};
    const datasLivres = {{ datas_livres|default([])|tojson }};

    function aplicarFlatpickr(selector, onChangeCallback) {
      flatpickr(selector, {
        dateFormat: "Y-m-d",
        minDate: "today",
        disable: [
          function(date) {
            return datasBloqueadas.includes(date.toISOString().split('T')[0]);
          }
        ],
        onDayCreate: function(dObj, dStr, fp, dayElem) {
          const dateStr = dayElem.dateObj.toISOString().split('T')[0];
          if (datasLivres.includes(dateStr)) {
            dayElem.classList.add("available");
          }
        },
        onChange: onChangeCallback
      });
    }

    aplicarFlatpickr("#data_evento", function(selectedDates, dateStr) {
      const evento = new Date(dateStr);
      if (!isNaN(evento)) {
        const retirada = new Date(evento);
        retirada.setDate(retirada.getDate() - 1);
        const devolucao = new Date(evento);
        devolucao.setDate(devolucao.getDate() + 1);

        $('#data_retirada').val(retirada.toISOString().split('T')[0]);
        $('#data_devolucao').val(devolucao.toISOString().split('T')[0]);
      }
    });

    aplicarFlatpickr("#data_prova");
  });
</script>
{% endblock %}
