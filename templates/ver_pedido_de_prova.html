{% extends 'base.html' %}
{% block title %}Pedido de Prova{% endblock %}

{% block content %}
<div class="container mt-4">
  <h3 class="mb-4">Pedido de Prova</h3>

  <div class="card {% if reserva.cancelada %}border-danger{% elif reserva.confirmada %}border-success{% else %}border-warning{% endif %}">
    <div class="card-body">
      <h5 class="card-title">{{ reserva.nome }}</h5>
      <p><strong>Telefone:</strong> {{ reserva.telefone }}</p>
      <p><strong>Item:</strong> {{ reserva.item.nome if reserva.item else 'Sem item vinculado' }}</p>
      <p><strong>Data da Prova:</strong> {{ reserva.data_evento.strftime('%d/%m/%Y') }}</p>
      <p><strong>Turno:</strong> {{ reserva.turno.title() if reserva.turno else '-' }}</p>
      <p>
        <strong>Status:</strong>
        {% if reserva.cancelada %}
          <span class="badge bg-danger">Cancelada</span>
        {% elif reserva.confirmada %}
          <span class="badge bg-success">Confirmada</span>
        {% else %}
          <span class="badge bg-warning text-dark">Pendente</span>
        {% endif %}
      </p>

      <hr>

      <div class="d-flex flex-wrap gap-2">
        {% if reserva.item %}
        <a href="{{ url_for('item', item_id=reserva.item.id) }}" class="btn btn-outline-secondary">
          <i class="bi bi-eye"></i> Ver Item
        </a>
        {% endif %}

        <a href="https://wa.me/55{{ reserva.telefone | replace('(', '') | replace(')', '') | replace('-', '') | replace(' ', '') }}?text={{ (
          reserva.cancelada 
          and 'Olá ' ~ reserva.nome ~ '! Seu pedido de prova foi cancelado. Se precisar reagendar, estamos à disposição.' 
          or 'Olá ' ~ reserva.nome ~ '! Sua reserva para o item "' ~ reserva.item.nome ~ '" está confirmada para o dia ' ~ reserva.data_evento.strftime('%d/%m/%Y') ~ ' no turno da ' ~ reserva.turno ~ '.' 
        ) | urlencode }}" 
        target="_blank" class="btn btn-outline-success">
          <i class="bi bi-whatsapp"></i> Enviar WhatsApp
        </a>

        {% if not reserva.confirmada and not reserva.cancelada %}
        <form method="POST" action="{{ url_for('confirmar_reserva', reserva_id=reserva.id) }}">
          <button type="submit" class="btn btn-outline-primary">
            <i class="bi bi-check2-circle"></i> Confirmar
          </button>
        </form>
        {% endif %}

        {% if not reserva.cancelada %}
        <form method="POST" action="{{ url_for('cancelar_reserva', reserva_id=reserva.id) }}" onsubmit="return confirm('Tem certeza que deseja cancelar este pedido?');">
          <button type="submit" class="btn btn-outline-danger">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
        </form>
        {% endif %}
        <a href="{{ url_for('catalogo') }}?nome={{ reserva.nome | urlencode }}&telefone={{ reserva.telefone | urlencode }}" class="btn btn-outline-success">
          <i class="bi bi-plus-circle"></i> Novo
        </a>
        
        <a href="{{ url_for('listar_reservas') }}" class="btn btn-outline-dark">
          <i class="bi bi-arrow-left"></i> Voltar
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}
