{% extends 'base.html' %}
{% block title %}{{ item.nome }}{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Mensagens de feedback -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} mt-3">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="row g-5 align-items-start">
    <!-- Carrossel de imagens -->
    <div class="col-12 col-lg-6 text-center">
      <div id="carouselItemDetalhe{{ item.id }}" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner rounded-4 shadow-sm">
          {% if imagens %}
            {% for imagem in imagens %}
              <div class="carousel-item {% if loop.first %}active{% endif %}">
                <img src="{{ url_for('static', filename='images/' ~ imagem.caminho) }}"
                     class="d-block w-100 img-fluid" alt="{{ item.nome }}">
                {% if imagem.caminho == item.imagem_principal %}
                  <div class="carousel-caption d-none d-md-block">
                    <span class="badge bg-primary">Miniatura</span>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <div class="carousel-item active">
              <img src="{{ url_for('static', filename='images/default.jpg') }}"
                   class="d-block w-100 img-fluid" alt="Imagem padrão">
            </div>
          {% endif %}
        </div>
        {% if imagens|length > 1 %}
          <button class="carousel-control-prev" type="button" data-bs-target="#carouselItemDetalhe{{ item.id }}" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#carouselItemDetalhe{{ item.id }}" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        {% endif %}
      </div>
    </div>

    <!-- Informações -->
    <div class="col-12 col-lg-6">
      <h2 class="fw-bold mb-3">{{ item.nome }}</h2>
      <ul class="list-unstyled">
        <li><strong>Tipo:</strong> {{ item.tipo.title() }}</li>
        {% if item.descricao %}
          <li><strong>Descrição:</strong> {{ item.descricao }}</li>
        {% endif %}
        <li><strong>Status:</strong>
          {% if item.disponivel %}
            <span class="badge bg-success">Disponível</span>
          {% else %}
            <span class="badge bg-danger">Indisponível</span>
          {% endif %}
        </li>
      </ul>

      <!-- Ações -->
      <div class="mt-4 d-flex flex-wrap gap-2">
        {% if item.disponivel %}
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#cadastroModal{{ item.id }}">
            Reservar
          </button>
        {% endif %}
        <a href="https://wa.me/5563984740162?text={{ 'Olá! Gostaria de informações sobre o item: ' ~ item.nome | urlencode }}"
           target="_blank" class="btn btn-outline-success">
          <i class="bi bi-whatsapp me-1"></i> Pedir informações
        </a>
        <a href="{{ url_for('catalogo') }}" class="btn btn-outline-primary">Catálogo</a>
      </div>
    </div>
  </div>
</div>

<!-- Modal de reserva -->
<div class="modal fade" id="cadastroModal{{ item.id }}" tabindex="-1" aria-labelledby="cadastroLabel{{ item.id }}" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('reservar', item_id=item.id) }}">
        <div class="modal-header">
          <h5 class="modal-title" id="cadastroLabel{{ item.id }}">Ficha de Reserva: {{ item.nome }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="nome{{ item.id }}" class="form-label">Nome completo</label>
            <input type="text" class="form-control" id="nome{{ item.id }}" name="nome" required>
          </div>
          <div class="mb-3">
            <label for="telefone{{ item.id }}" class="form-label">Telefone</label>
            <input type="tel" class="form-control" id="telefone{{ item.id }}" name="telefone" required>
          </div>
          <div class="mb-3">
            <label for="data_evento{{ item.id }}" class="form-label">Data para reservar à prova</label>
            <input type="text" class="form-control" id="data_evento{{ item.id }}" name="data_evento" required>
          </div>
          <div class="mb-3">
            <label for="turno{{ item.id }}" class="form-label">Turno</label>
            <select class="form-select" id="turno{{ item.id }}" name="turno" required>
              <option value="">Selecione</option>
              <option value="manhã" {% if reservas_por_turno['manhã'] >= 2 %}disabled{% endif %}>
                Manhã {% if reservas_por_turno['manhã'] >= 2 %}- Indisponível{% endif %}
              </option>
              <option value="tarde" {% if reservas_por_turno['tarde'] >= 2 %}disabled{% endif %}>
                Tarde {% if reservas_por_turno['tarde'] >= 2 %}- Indisponível{% endif %}
              </option>
            </select>
          </div>
        </div>
        {% if reservas_por_turno['manhã'] >= 2 and reservas_por_turno['tarde'] >= 2 %}
        <div class="alert alert-danger text-center">
          Nenhum turno disponível para a data selecionada. Por favor, escolha outra data.
        </div>
        {% endif %}
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Enviar Reserva</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Flatpickr CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Estilo para datas livres -->
<style>
  .flatpickr-day.available {
    background-color: #a3e635 !important;
    border-radius: 50% !important;
    color: black !important;
  }
</style>

<!-- Script para aplicar datas livres -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const datasLivres = {{ datas_livres|default([])|tojson }};
    const turnoSelect = document.getElementById("turno{{ item.id }}");

    flatpickr("#data_evento{{ item.id }}", {
      dateFormat: "Y-m-d",
      minDate: "{{ current_date }}",
      disable: [
        function(date) {
          return !datasLivres.includes(date.toISOString().split('T')[0]);
        }
      ],
      onChange: function(selectedDates, dateStr) {
        const selected = new Date(dateStr);
        const day = selected.getDay(); // 0 = domingo, 6 = sábado

        // Reset opções
        for (const opt of turnoSelect.options) {
          opt.disabled = false;
          opt.hidden = false;
        }

        if (day === 6) {
          // sábado: desabilita tarde
          for (const opt of turnoSelect.options) {
            if (opt.value === "tarde") {
              opt.disabled = true;
              opt.hidden = true;
            }
          }
        } else if (day === 0) {
          // domingo: desabilita todos
          for (const opt of turnoSelect.options) {
            if (opt.value !== "") {
              opt.disabled = true;
              opt.hidden = true;
            }
          }
        }
      },
      onDayCreate: function(dObj, dStr, fp, dayElem) {
        const dateStr = dayElem.dateObj.toISOString().split('T')[0];
        if (datasLivres.includes(dateStr)) {
          dayElem.classList.add("available");
        }
      }
    });
  });
</script>
{% endblock %}
